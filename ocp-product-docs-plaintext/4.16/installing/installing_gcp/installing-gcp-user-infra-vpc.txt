Installing a cluster into a shared VPC on GCP using Deployment Manager templates

In Red Hat OpenShift Container Platform version 4.16, you can install a cluster into a shared Virtual Private Cloud (VPC) on Google Cloud Platform (GCP) that uses infrastructure that you provide. In this context, a cluster installed into a shared VPC is a cluster that is configured to use a VPC from a project different from where the cluster is being deployed.

A shared VPC enables an organization to connect resources from multiple projects to a common VPC network. You can communicate within the organization securely and efficiently by using internal IPs from that network. For more information about shared VPC, see Shared VPC overview in the GCP documentation.

The steps for performing a user-provided infrastructure installation into a shared VPC are outlined here. Several Deployment Manager templates are provided to assist in completing these steps or to help model your own. You are also free to create the required resources through other methods.

The steps for performing a user-provisioned infrastructure installation are provided as an example only. Installing a cluster with infrastructure you provide requires knowledge of the cloud provider and the installation process of Red Hat OpenShift Container Platform. Several Deployment Manager templates are provided to assist in completing these steps or to help model your own. You are also free to create the required resources through other methods; the templates are just an example.
Prerequisites
You reviewed details about the Red Hat OpenShift Container Platform installation and update processes.

You read the documentation on selecting a cluster installation method and preparing it for users.

If you use a firewall and plan to use the Telemetry service, you configured the firewall to allow the sites that your cluster requires access to.

If the cloud identity and access management (IAM) APIs are not accessible in your environment, or if you do not want to store an administrator-level credential secret in the kube-system namespace, you can manually create and maintain long-term credentials.
Certificate signing requests management
Because your cluster has limited access to automatic machine management when you use infrastructure that you provision, you must provide a mechanism for approving cluster certificate signing requests (CSRs) after installation. The kube-controller-manager only approves the kubelet client CSRs. The machine-approver cannot guarantee the validity of a serving certificate that is requested by using kubelet credentials because it cannot confirm that the correct machine issued the request. You must determine and implement a method of verifying the validity of the kubelet serving certificate requests and approving them.
Internet access for Red Hat OpenShift Container Platform
In Red Hat OpenShift Container Platform 4.16, you require access to the internet to install your cluster.

You must have internet access to:

Access https://console.redhat.com/openshift [OpenShift Cluster Manager] to download the installation program and perform subscription management. If the cluster has internet access and you do not disable Telemetry, that service automatically entitles your cluster.

Access Quay.io to obtain the packages that are required to install your cluster.

Obtain the packages that are required to perform cluster updates.
Configuring the GCP project that hosts your cluster
Before you can install Red Hat OpenShift Container Platform, you must configure a Google Cloud Platform (GCP) project to host it.

Creating a GCP project
To install Red Hat OpenShift Container Platform, you must create a project in your Google Cloud Platform (GCP) account to host the cluster.

Create a project to host your Red Hat OpenShift Container Platform cluster. See
Creating and Managing Projects in the GCP documentation.
Enabling API services in GCP
Your Google Cloud Platform (GCP) project requires access to several API services to complete Red Hat OpenShift Container Platform installation.

You created a project to host your cluster.


Enable the following required API services in the project that hosts your
cluster. You may also enable optional API services which are not required for installation. See
Enabling services
in the GCP documentation.
GCP account limits
The Red Hat OpenShift Container Platform cluster uses a number of Google Cloud Platform (GCP) components, but the default Quotas do not affect your ability to install a default Red Hat OpenShift Container Platform cluster.

A default cluster, which contains three compute and three control plane machines, uses the following resources. Note that some resources are required only during the bootstrap process and are removed after the cluster deploys.


If any of the quotas are insufficient during installation, the installation program displays an error that states both which quota was exceeded and the region.
Be sure to consider your actual cluster size, planned cluster growth, and any usage from other clusters that are associated with your account. The CPU, static IP addresses, and persistent disk SSD (storage) quotas are the ones that are most likely to be insufficient.

If you plan to deploy your cluster in one of the following regions, you will exceed the maximum storage quota and are likely to exceed the CPU quota limit:

asia-east2

asia-northeast2

asia-south1

australia-southeast1

europe-north1

europe-west2

europe-west3

europe-west6

northamerica-northeast1

southamerica-east1

us-west2


You can increase resource quotas from the GCP console, but you might need to file a support ticket. Be sure to plan your cluster size early so that you can allow time to resolve the support ticket before you install your Red Hat OpenShift Container Platform cluster.
Creating a service account in GCP
Red Hat OpenShift Container Platform requires a Google Cloud Platform (GCP) service account that provides authentication and authorization to access data in the Google APIs. If you do not have an existing IAM service account that contains the required roles in your project, you must create one.

You created a project to host your cluster.


Create a service account in the project that you use to host your
Red Hat OpenShift Container Platform cluster. See
Creating a service account
in the GCP documentation.

Grant the service account the appropriate permissions. You can either
grant the individual permissions that follow or assign the Owner role to it.
See Granting roles to a service account for specific resources.

You can create the service account key in JSON format, or attach the service account to a GCP virtual machine.
See Creating service account keys and Creating and enabling service accounts for instances in the GCP documentation.


Required GCP roles
When you attach the Owner role to the service account that you create, you grant that service account all permissions, including those that are required to install Red Hat OpenShift Container Platform. If your organization's security policies require a more restrictive set of permissions, you can create a service account with the following permissions. If you deploy your cluster into an existing virtual private cloud (VPC), the service account does not require certain networking permissions, which are noted in the following lists:

Compute Admin

Role Administrator

Security Admin

Service Account Admin

Service Account Key Admin

Service Account User

Storage Admin


DNS Administrator


Compute Load Balancer Admin


Deployment Manager Editor


The following roles are applied to the service accounts that the control plane and compute machines use:
Supported GCP regions
You can deploy an Red Hat OpenShift Container Platform cluster to the following Google Cloud Platform (GCP) regions:

africa-south1 (Johannesburg, South Africa)

asia-east1 (Changhua County, Taiwan)

asia-east2 (Hong Kong)

asia-northeast1 (Tokyo, Japan)

asia-northeast2 (Osaka, Japan)

asia-northeast3 (Seoul, South Korea)

asia-south1 (Mumbai, India)

asia-south2 (Delhi, India)

asia-southeast1 (Jurong West, Singapore)

asia-southeast2 (Jakarta, Indonesia)

australia-southeast1 (Sydney, Australia)

australia-southeast2 (Melbourne, Australia)

europe-central2 (Warsaw, Poland)

europe-north1 (Hamina, Finland)

europe-southwest1 (Madrid, Spain)

europe-west1 (St. Ghislain, Belgium)

europe-west2 (London, England, UK)

europe-west3 (Frankfurt, Germany)

europe-west4 (Eemshaven, Netherlands)

europe-west6 (Zürich, Switzerland)

europe-west8 (Milan, Italy)

europe-west9 (Paris, France)

europe-west12 (Turin, Italy)

me-central1 (Doha, Qatar, Middle East)

me-central2 (Dammam, Saudi Arabia, Middle East)

me-west1 (Tel Aviv, Israel)

northamerica-northeast1 (Montréal, Québec, Canada)

northamerica-northeast2 (Toronto, Ontario, Canada)

southamerica-east1 (São Paulo, Brazil)

southamerica-west1 (Santiago, Chile)

us-central1 (Council Bluffs, Iowa, USA)

us-east1 (Moncks Corner, South Carolina, USA)

us-east4 (Ashburn, Northern Virginia, USA)

us-east5 (Columbus, Ohio)

us-south1 (Dallas, Texas)

us-west1 (The Dalles, Oregon, USA)

us-west2 (Los Angeles, California, USA)

us-west3 (Salt Lake City, Utah, USA)

us-west4 (Las Vegas, Nevada, USA)


To determine which machine type instances are available by region and zone, see the Google documentation.
Installing and configuring CLI tools for GCP
To install Red Hat OpenShift Container Platform on Google Cloud Platform (GCP) using user-provisioned infrastructure, you must install and configure the CLI tools for GCP.

You created a project to host your cluster.

You created a service account and granted it the required permissions.


Install the following binaries in $PATH:

Authenticate using the gcloud tool with your configured service account.
Requirements for a cluster with user-provisioned infrastructure
For a cluster that contains user-provisioned infrastructure, you must deploy all of the required machines.

This section describes the requirements for deploying Red Hat OpenShift Container Platform on user-provisioned infrastructure.

Required machines for cluster installation
The smallest Red Hat OpenShift Container Platform clusters require the following hosts:


To maintain high availability of your cluster, use separate physical hosts for these cluster machines.
The bootstrap and control plane machines must use Red Hat Enterprise Linux CoreOS (RHCOS) as the operating system. However, the compute machines can choose between Red Hat Enterprise Linux CoreOS (RHCOS), Red Hat Enterprise Linux (RHEL) 8.6 and later.

Note that RHCOS is based on Red Hat Enterprise Linux (RHEL) 9.2 and inherits all of its hardware certifications and requirements. See Red Hat Enterprise Linux technology capabilities and limits.
Minimum resource requirements for cluster installation
Each cluster machine must meet the following minimum requirements:


One vCPU is equivalent to one physical core when simultaneous multithreading (SMT), or hyperthreading, is not enabled. When enabled, use the following formula to calculate the corresponding ratio: (threads per core × cores) × sockets = vCPUs.

Red Hat OpenShift Container Platform and Kubernetes are sensitive to disk performance, and faster storage is recommended, particularly for etcd on the control plane nodes which require a 10 ms p99 fsync duration. Note that on many cloud platforms, storage size and IOPS scale together, so you might need to over-allocate storage volume to obtain sufficient performance.

As with all user-provisioned installations, if you choose to use RHEL compute machines in your cluster, you take responsibility for all operating system life cycle management and maintenance, including performing system updates, applying patches, and completing all other required tasks. Use of RHEL 7 compute machines is deprecated and has been removed in Red Hat OpenShift Container Platform 4.10 and later.
As of Red Hat OpenShift Container Platform version 4.13, RHCOS is based on RHEL version 9.2, which updates the micro-architecture requirements. The following list contains the minimum instruction set architectures (ISA) that each architecture requires:

x86-64 architecture requires x86-64-v2 ISA

ARM64 architecture requires ARMv8.0-A ISA

IBM Power architecture requires Power 9 ISA

s390x architecture requires z14 ISA


For more information, see RHEL Architectures.
If an instance type for your platform meets the minimum requirements for cluster machines, it is supported to use in Red Hat OpenShift Container Platform.

Optimizing storage
Tested instance types for GCP
The following Google Cloud Platform instance types have been tested with Red Hat OpenShift Container Platform.

https://raw.githubusercontent.com/openshift/installer/master/docs/user/gcp/tested_instance_types.md
Using custom machine types
Using a custom machine type to install a Red Hat OpenShift Container Platform cluster is supported.

Consider the following when using a custom machine type:

Similar to predefined instance types, custom machine types must meet the minimum resource requirements for control plane and compute machines. For more information, see "Minimum resource requirements for cluster installation".

The name of the custom machine type must adhere to the following syntax:
Configuring the GCP project that hosts your shared VPC network
If you use a shared Virtual Private Cloud (VPC) to host your Red Hat OpenShift Container Platform cluster in Google Cloud Platform (GCP), you must configure the project that hosts it.

If you already have a project that hosts the shared VPC network, review this section to ensure that the project meets all of the requirements to install an Red Hat OpenShift Container Platform cluster.
Create a project to host the shared VPC for your Red Hat OpenShift Container Platform cluster. See
Creating and Managing Projects in the GCP documentation.

Create a service account in the project that hosts your shared VPC. See
Creating a service account
in the GCP documentation.

Grant the service account the appropriate permissions. You can either
grant the individual permissions that follow or assign the Owner role to it.
See Granting roles to a service account for specific resources.


Configuring DNS for GCP
To install Red Hat OpenShift Container Platform, the Google Cloud Platform (GCP) account you use must have a dedicated public hosted zone in the project that hosts the shared VPC that you install the cluster into. This zone must be authoritative for the domain. The DNS service provides cluster DNS resolution and name lookup for external connections to the cluster.

Identify your domain, or subdomain, and registrar. You can transfer an existing domain and
registrar or obtain a new one through GCP or another source.

Create a public hosted zone for your domain or subdomain in your GCP project. See
Creating public zones
in the GCP documentation.

Extract the new authoritative name servers from the hosted zone records. See
Look up your Cloud DNS name servers
in the GCP documentation.

Update the registrar records for the name servers that your domain
uses. For example, if you registered your domain to Google Domains, see the
following topic in the Google Domains Help:
How to switch to custom name servers.

If you migrated your root domain to Google Cloud DNS, migrate your DNS records. See Migrating to Cloud DNS in the GCP documentation.

If you use a subdomain, follow your company's procedures to add its delegation records to the parent domain. This process might include a request to your company's IT department or the division that controls the root domain and DNS services for your company.
Creating a VPC in GCP
You must create a VPC in Google Cloud Platform (GCP) for your Red Hat OpenShift Container Platform cluster to use. You can customize the VPC to meet your requirements. One way to create the VPC is to modify the provided Deployment Manager template.

If you do not use the provided Deployment Manager template to create your GCP infrastructure, you must review the provided information and manually create the infrastructure. If your cluster does not initialize correctly, you might have to contact Red Hat support with your installation logs.
Configure a GCP account.


Copy the template from the Deployment Manager template for the VPC
section of this topic and save it as 01_vpc.py on your computer. This template
describes the VPC that your cluster requires.

Export the following variables required by the resource definition:

Export the variable for the ID of the project that hosts the shared VPC:

Export the variable for the email of the service account that belongs to host project:

Create a 01_vpc.yaml resource definition file:

Create the deployment by using the gcloud CLI:

Export the VPC variable that other components require:

Set up the shared VPC. See Setting up Shared VPC in the GCP documentation.


Deployment Manager template for the VPC
You can use the following Deployment Manager template to deploy the VPC that you need for your Red Hat OpenShift Container Platform cluster:

link:https://raw.githubusercontent.com/openshift/installer/release-4.15/upi/gcp/01_vpc.py[role=include]
Creating the installation files for GCP
To install Red Hat OpenShift Container Platform on Google Cloud Platform (GCP) using user-provisioned infrastructure, you must generate the files that the installation program needs to deploy your cluster and modify them so that the cluster creates only the machines that it will use. You generate and customize the install-config.yaml file, Kubernetes manifests, and Ignition config files. You also have the option to first set up a separate var partition during the preparation phases of installation.

Manually creating the installation configuration file
Installing the cluster requires that you manually create the installation configuration file.

You have an SSH public key on your local machine to provide to the installation program. The key will be used for SSH authentication onto your cluster nodes for debugging and disaster recovery.

You have obtained the Red Hat OpenShift Container Platform installation program and the pull secret for your
cluster.


Create an installation directory to store your required installation assets in:

Customize the sample install-config.yaml file template that is provided and save
it in the <installation_directory>.

Back up the install-config.yaml file so that you can use it to install multiple clusters.


Installation configuration parameters for GCP
Enabling Shielded VMs
You can use Shielded VMs when installing your cluster. Shielded VMs have extra security features including secure boot, firmware and integrity monitoring, and rootkit detection. For more information, see Google's documentation on Shielded VMs.

Shielded VMs are currently not supported on clusters with 64-bit ARM infrastructures.
You have created an install-config.yaml file.


Use a text editor to edit the install-config.yaml file prior to deploying your cluster and add one of the following stanzas:
Enabling Confidential VMs
You can use Confidential VMs when installing your cluster. Confidential VMs encrypt data while it is being processed. For more information, see Google's documentation on Confidential Computing. You can enable Confidential VMs and Shielded VMs at the same time, although they are not dependent on each other.

Confidential VMs are currently not supported on 64-bit ARM architectures.
You have created an install-config.yaml file.


Use a text editor to edit the install-config.yaml file prior to deploying your cluster and add one of the following stanzas:
Sample customized install-config.yaml file for GCP
You can customize the install-config.yaml file to specify more details about your Red Hat OpenShift Container Platform cluster's platform or modify the values of the required parameters.

This sample YAML file is provided for reference only. You must obtain your install-config.yaml file by using the installation program and modify it.
apiVersion: v1
baseDomain: example.com 1
controlPlane: 2
  hyperthreading: Enabled 3 4
  name: master
  platform:
    gcp:
      type: n2-standard-4
      zones:
      - us-central1-a
      - us-central1-c
      tags: 5
      - control-plane-tag1
      - control-plane-tag2
  replicas: 3
compute: 2
- hyperthreading: Enabled 3
  name: worker
  platform:
    gcp:
      type: n2-standard-4
      zones:
      - us-central1-a
      - us-central1-c
      tags: 5
      - compute-tag1
      - compute-tag2
  replicas: 0
metadata:
  name: test-cluster
networking:
  clusterNetwork:
  - cidr: 10.128.0.0/14
    hostPrefix: 23
  machineNetwork:
  - cidr: 10.0.0.0/16
  networkType: OVNKubernetes 6
  serviceNetwork:
  - 172.30.0.0/16
platform:
  gcp:
    defaultMachinePlatform:
      tags: 5
      - global-tag1
      - global-tag2
    projectID: openshift-production 7
    region: us-central1 8
pullSecret: '{"auths": ...}'
fips: false 9
sshKey: ssh-ed25519 AAAA... 10
publish: Internal 11
Specify the public DNS on the host project.

If you do not provide these parameters and values, the installation program provides the default value.

The controlPlane section is a single mapping, but the compute section is a sequence of mappings. To meet the requirements of the different data structures, the first line of the compute section must begin with a hyphen, -, and the first line of the controlPlane section must not. Although both sections currently define a single machine pool, it is possible that future versions of Red Hat OpenShift Container Platform will support defining multiple compute pools during installation. Only one control plane pool is used.

Whether to enable or disable simultaneous multithreading, or hyperthreading. By default, simultaneous multithreading is enabled to increase the performance of your machines' cores. You can disable it by setting the parameter value to Disabled. If you disable simultaneous multithreading in some cluster machines, you must disable it in all cluster machines.

Optional: A set of network tags to apply to the control plane or compute machine sets. The platform.gcp.defaultMachinePlatform.tags parameter applies to both control plane and compute machines. If the compute.platform.gcp.tags or controlPlane.platform.gcp.tags parameters are set, they override the platform.gcp.defaultMachinePlatform.tags parameter.

The cluster network plugin to install. The default value OVNKubernetes is the only supported value.

Specify the main project where the VM instances reside.

Specify the region that your VPC network is in.

Whether to enable or disable FIPS mode. By default, FIPS mode is not enabled. If FIPS mode is enabled, the Red Hat Enterprise Linux CoreOS (RHCOS) machines that Red Hat OpenShift Container Platform runs on bypass the default Kubernetes cryptography suite and use the cryptography modules that are provided with RHCOS instead.

You can optionally provide the sshKey value that you use to access the machines in your cluster.

How to publish the user-facing endpoints of your cluster. Set publish to Internal to deploy a private cluster, which cannot be accessed from the internet. The default value is External.
To use a shared VPC in a cluster that uses infrastructure that you provision, you must set publish to Internal. The installation program will no longer be able to access the public DNS zone for the base domain in the host project.
Configuring the cluster-wide proxy during installation
Production environments can deny direct access to the internet and instead have an HTTP or HTTPS proxy available. You can configure a new Red Hat OpenShift Container Platform cluster to use a proxy by configuring the proxy settings in the install-config.yaml file.

You have an existing install-config.yaml file.

You reviewed the sites that your cluster requires access to and determined whether any of them need to bypass the proxy. By default, all cluster egress traffic is proxied, including calls to hosting cloud provider APIs. You added sites to the Proxy object's spec.noProxy field to bypass the proxy if necessary.


Edit your install-config.yaml file and add the proxy settings. For example:

Save the file and reference it when installing Red Hat OpenShift Container Platform.


The installation program creates a cluster-wide proxy that is named cluster that uses the proxy settings in the provided install-config.yaml file. If no proxy settings are provided, a cluster Proxy object is still created, but it will have a nil spec.

Only the Proxy object named cluster is supported, and no additional proxies can be created.
Creating the Kubernetes manifest and Ignition config files
Because you must modify some cluster definition files and manually start the cluster machines, you must generate the Kubernetes manifest and Ignition config files that the cluster needs to configure the machines.

The installation configuration file transforms into the Kubernetes manifests. The manifests wrap into the Ignition configuration files, which are later used to configure the cluster machines.

The Ignition config files that the Red Hat OpenShift Container Platform installation program generates contain certificates that expire after 24 hours, which are then renewed at that time. If the cluster is shut down before renewing the certificates and the cluster is later restarted after the 24 hours have elapsed, the cluster automatically recovers the expired certificates. The exception is that you must manually approve the pending node-bootstrapper certificate signing requests (CSRs) to recover kubelet certificates. See the documentation for Recovering from expired control plane certificates for more information.

It is recommended that you use Ignition config files within 12 hours after they are generated because the 24-hour certificate rotates from 16 to 22 hours after the cluster is installed. By using the Ignition config files within 12 hours, you can avoid installation failure if the certificate update runs during installation.
You obtained the Red Hat OpenShift Container Platform installation program.

You created the install-config.yaml installation configuration file.


Change to the directory that contains the Red Hat OpenShift Container Platform installation program and generate the Kubernetes manifests for the cluster:

Remove the Kubernetes manifest files that define the control plane machines:

Remove the Kubernetes manifest files that define the control plane machine set:

Remove the Kubernetes manifest files that define the worker machines:

Check that the mastersSchedulable parameter in the <installation_directory>/manifests/cluster-scheduler-02-config.yml Kubernetes manifest file is set to false. This setting prevents pods from being scheduled on the control plane machines:

Remove the privateZone
sections from the <installation_directory>/manifests/cluster-dns-02-config.yml DNS configuration file:

Configure the cloud provider for your VPC.

If you deploy a cluster that is not on a private network, open the <installation_directory>/manifests/cluster-ingress-default-ingresscontroller.yaml file and replace the value of the scope parameter with External. The contents of the file resemble the following example:

To create the Ignition configuration files, run the following command from the directory that contains the installation program:
Exporting common variables
Extracting the infrastructure name
The Ignition config files contain a unique cluster identifier that you can use to uniquely identify your cluster in Google Cloud Platform (GCP). The infrastructure name is also used to locate the appropriate GCP resources during an Red Hat OpenShift Container Platform installation. The provided Deployment Manager templates contain references to this infrastructure name, so you must extract it.

You obtained the Red Hat OpenShift Container Platform installation program and the pull secret for your cluster.

You generated the Ignition config files for your cluster.

You installed the jq package.


To extract and view the infrastructure name from the Ignition config file
metadata, run the following command:
Exporting common variables for Deployment Manager templates
You must export a common set of variables that are used with the provided Deployment Manager templates used to assist in completing a user-provided infrastructure install on Google Cloud Platform (GCP).

Specific Deployment Manager templates can also require additional exported variables, which are detailed in their related procedures.
Obtain the Red Hat OpenShift Container Platform installation program and the pull secret for your cluster.

Generate the Ignition config files for your cluster.

Install the jq package.


Export the following common variables to be used by the provided Deployment Manager
templates:


$ export BASE_DOMAIN='<base_domain>' 1
$ export BASE_DOMAIN_ZONE_NAME='<base_domain_zone_name>' 1
$ export NETWORK_CIDR='10.0.0.0/16'

$ export KUBECONFIG=<installation_directory>/auth/kubeconfig 2
$ export CLUSTER_NAME=`jq -r .clusterName <installation_directory>/metadata.json`
$ export INFRA_ID=`jq -r .infraID <installation_directory>/metadata.json`
$ export PROJECT_NAME=`jq -r .gcp.projectID <installation_directory>/metadata.json`
Supply the values for the host project.

For <installation_directory>, specify the path to the directory that you stored the installation files in.
Networking requirements for user-provisioned infrastructure
All the Red Hat Enterprise Linux CoreOS (RHCOS) machines require networking to be configured in initramfs during boot to fetch their Ignition config files.

Setting the cluster node hostnames through DHCP
On Red Hat Enterprise Linux CoreOS (RHCOS) machines, the hostname is set through NetworkManager. By default, the machines obtain their hostname through DHCP. If the hostname is not provided by DHCP, set statically through kernel arguments, or another method, it is obtained through a reverse DNS lookup. Reverse DNS lookup occurs after the network has been initialized on a node and can take time to resolve. Other system services can start prior to this and detect the hostname as localhost or similar. You can avoid this by using DHCP to provide the hostname for each cluster node.

Additionally, setting the hostnames through DHCP can bypass any manual DNS record name configuration errors in environments that have a DNS split-horizon implementation.
Network connectivity requirements
You must configure the network connectivity between machines to allow Red Hat OpenShift Container Platform cluster components to communicate. Each machine must be able to resolve the hostnames of all other machines in the cluster.

This section provides details about the ports that are required.

In connected Red Hat OpenShift Container Platform environments, all nodes are required to have internet access to pull images for platform containers and provide telemetry data to Red Hat.
Creating load balancers in GCP
You must configure load balancers in Google Cloud Platform (GCP) for your Red Hat OpenShift Container Platform cluster to use. One way to create these components is to modify the provided Deployment Manager template.

If you do not use the provided Deployment Manager template to create your GCP infrastructure, you must review the provided information and manually create the infrastructure. If your cluster does not initialize correctly, you might have to contact Red Hat support with your installation logs.
Configure a GCP account.

Generate the Ignition config files for your cluster.

Create and configure a VPC and associated subnets in GCP.


Copy the template from the Deployment Manager template for the internal load balancer
section of this topic and save it as 02_lb_int.py on your computer. This
template describes the internal load balancing objects that your cluster
requires.

For an external cluster, also copy the template from the Deployment Manager template for the external load balancer
section of this topic and save it as 02_lb_ext.py on your computer. This
template describes the external load balancing objects that your cluster
requires.

Export the variables that the deployment template uses:

Create a 02_infra.yaml resource definition file:

Create the deployment by using the gcloud CLI:

Export the cluster IP address:

For an external cluster, also export the cluster public IP address:


Deployment Manager template for the external load balancer
You can use the following Deployment Manager template to deploy the external load balancer that you need for your Red Hat OpenShift Container Platform cluster:

link:https://raw.githubusercontent.com/openshift/installer/release-4.15/upi/gcp/02_lb_ext.py[role=include]
Deployment Manager template for the internal load balancer
You can use the following Deployment Manager template to deploy the internal load balancer that you need for your Red Hat OpenShift Container Platform cluster:

link:https://raw.githubusercontent.com/openshift/installer/release-4.15/upi/gcp/02_lb_int.py[role=include]
You will need this template in addition to the 02_lb_ext.py template when you create an external cluster.
Creating a private DNS zone in GCP
You must configure a private DNS zone in Google Cloud Platform (GCP) for your Red Hat OpenShift Container Platform cluster to use. One way to create this component is to modify the provided Deployment Manager template.

If you do not use the provided Deployment Manager template to create your GCP infrastructure, you must review the provided information and manually create the infrastructure. If your cluster does not initialize correctly, you might have to contact Red Hat support with your installation logs.
Configure a GCP account.

Generate the Ignition config files for your cluster.

Create and configure a VPC and associated subnets in GCP.


Copy the template from the Deployment Manager template for the private DNS
section of this topic and save it as 02_dns.py on your computer. This
template describes the private DNS objects that your cluster
requires.

Create a 02_dns.yaml resource definition file:

Create the deployment by using the gcloud CLI:

The templates do not create DNS entries due to limitations of Deployment
Manager, so you must create them manually:


Deployment Manager template for the private DNS
You can use the following Deployment Manager template to deploy the private DNS that you need for your Red Hat OpenShift Container Platform cluster:

link:https://raw.githubusercontent.com/openshift/installer/release-4.15/upi/gcp/02_dns.py[role=include]
Creating firewall rules in GCP
You must create firewall rules in Google Cloud Platform (GCP) for your Red Hat OpenShift Container Platform cluster to use. One way to create these components is to modify the provided Deployment Manager template.

If you do not use the provided Deployment Manager template to create your GCP infrastructure, you must review the provided information and manually create the infrastructure. If your cluster does not initialize correctly, you might have to contact Red Hat support with your installation logs.
Configure a GCP account.

Generate the Ignition config files for your cluster.

Create and configure a VPC and associated subnets in GCP.


Copy the template from the
Deployment Manager template for firewall rules
section of this topic and save it as 03_firewall.py on your computer. This
template describes the security groups that your cluster requires.

Create a 03_firewall.yaml resource definition file:

Create the deployment by using the gcloud CLI:


Deployment Manager template for firewall rules
You can use the following Deployment Manager template to deploy the firewall rues that you need for your Red Hat OpenShift Container Platform cluster:

link:https://raw.githubusercontent.com/openshift/installer/release-4.15/upi/gcp/03_firewall.py[role=include]
Creating IAM roles in GCP
You must create IAM roles in Google Cloud Platform (GCP) for your Red Hat OpenShift Container Platform cluster to use. One way to create these components is to modify the provided Deployment Manager template.

If you do not use the provided Deployment Manager template to create your GCP infrastructure, you must review the provided information and manually create the infrastructure. If your cluster does not initialize correctly, you might have to contact Red Hat support with your installation logs.
Configure a GCP account.

Generate the Ignition config files for your cluster.

Create and configure a VPC and associated subnets in GCP.


Copy the template from the
Deployment Manager template for IAM roles
section of this topic and save it as 03_iam.py on your computer. This
template describes the IAM roles that your cluster requires.

Create a 03_iam.yaml resource definition file:

Create the deployment by using the gcloud CLI:

Export the variable for the master service account:

Export the variable for the worker service account:

Assign the permissions that the installation program requires to the service accounts for the subnets that host the control plane and compute subnets:

The templates do not create the policy bindings due to limitations of Deployment
Manager, so you must create them manually:

Create a service account key and store it locally for later use:


Deployment Manager template for IAM roles
You can use the following Deployment Manager template to deploy the IAM roles that you need for your Red Hat OpenShift Container Platform cluster:

link:https://raw.githubusercontent.com/openshift/installer/release-4.15/upi/gcp/03_iam.py[role=include]
Creating the RHCOS cluster image for the GCP infrastructure
You must use a valid Red Hat Enterprise Linux CoreOS (RHCOS) image for Google Cloud Platform (GCP) for your Red Hat OpenShift Container Platform nodes.

Obtain the RHCOS image from the RHCOS image mirror page.

Create the Google storage bucket:

Upload the RHCOS image to the Google storage bucket:

Export the uploaded RHCOS image location as a variable:

Create the cluster image:
Creating the bootstrap machine in GCP
You must create the bootstrap machine in Google Cloud Platform (GCP) to use during Red Hat OpenShift Container Platform cluster initialization. One way to create this machine is to modify the provided Deployment Manager template.

If you do not use the provided Deployment Manager template to create your bootstrap machine, you must review the provided information and manually create the infrastructure. If your cluster does not initialize correctly, you might have to contact Red Hat support with your installation logs.
Configure a GCP account.

Generate the Ignition config files for your cluster.

Create and configure a VPC and associated subnets in GCP.

Create and configure networking and load balancers in GCP.

Create control plane and compute roles.

Ensure pyOpenSSL is installed.


Copy the template from the Deployment Manager template for the bootstrap machine
section of this topic and save it as 04_bootstrap.py on your computer. This
template describes the bootstrap machine that your cluster requires.

Export the location of the Red Hat Enterprise Linux CoreOS (RHCOS) image that the installation program requires:

Create a bucket and upload the bootstrap.ign file:

Create a signed URL for the bootstrap instance to use to access the Ignition
config. Export the URL from the output as a variable:

Create a 04_bootstrap.yaml resource definition file:

Create the deployment by using the gcloud CLI:

Add the bootstrap instance to the internal load balancer instance group:

Add the bootstrap instance group to the internal load balancer backend service:


Deployment Manager template for the bootstrap machine
You can use the following Deployment Manager template to deploy the bootstrap machine that you need for your Red Hat OpenShift Container Platform cluster:

link:https://raw.githubusercontent.com/openshift/installer/release-4.15/upi/gcp/04_bootstrap.py[role=include]
Creating the control plane machines in GCP
You must create the control plane machines in Google Cloud Platform (GCP) for your cluster to use. One way to create these machines is to modify the provided Deployment Manager template.

If you do not use the provided Deployment Manager template to create your control plane machines, you must review the provided information and manually create the infrastructure. If your cluster does not initialize correctly, you might have to contact Red Hat support with your installation logs.
Configure a GCP account.

Generate the Ignition config files for your cluster.

Create and configure a VPC and associated subnets in GCP.

Create and configure networking and load balancers in GCP.

Create control plane and compute roles.

Create the bootstrap machine.


Copy the template from the Deployment Manager template for control plane machines
section of this topic and save it as 05_control_plane.py on your computer.
This template describes the control plane machines that your cluster requires.

Export the following variable required by the resource definition:

Create a 05_control_plane.yaml resource definition file:

Create the deployment by using the gcloud CLI:

The templates do not manage load balancer membership due to limitations of Deployment
Manager, so you must add the control plane machines manually.


Deployment Manager template for control plane machines
You can use the following Deployment Manager template to deploy the control plane machines that you need for your Red Hat OpenShift Container Platform cluster:

link:https://raw.githubusercontent.com/openshift/installer/release-4.15/upi/gcp/05_control_plane.py[role=include]
Wait for bootstrap completion and remove bootstrap resources in GCP
After you create all of the required infrastructure in Google Cloud Platform (GCP), wait for the bootstrap process to complete on the machines that you provisioned by using the Ignition config files that you generated with the installation program.

Configure a GCP account.

Generate the Ignition config files for your cluster.

Create and configure a VPC and associated subnets in GCP.

Create and configure networking and load balancers in GCP.

Create control plane and compute roles.

Create the bootstrap machine.

Create the control plane machines.


Change to the directory that contains the installation program and run the
following command:

Delete the bootstrap resources:
Creating additional worker machines in GCP
You can create worker machines in Google Cloud Platform (GCP) for your cluster to use by launching individual instances discretely or by automated processes outside the cluster, such as auto scaling groups. You can also take advantage of the built-in cluster scaling mechanisms and the machine API in Red Hat OpenShift Container Platform.

In this example, you manually launch one instance by using the Deployment Manager template. Additional instances can be launched by including additional resources of type 06_worker.py in the file.

If you do not use the provided Deployment Manager template to create your worker machines, you must review the provided information and manually create the infrastructure. If your cluster does not initialize correctly, you might have to contact Red Hat support with your installation logs.
Configure a GCP account.

Generate the Ignition config files for your cluster.

Create and configure a VPC and associated subnets in GCP.

Create and configure networking and load balancers in GCP.

Create control plane and compute roles.

Create the bootstrap machine.

Create the control plane machines.


Copy the template from the Deployment Manager template for worker machines
section of this topic and save it as 06_worker.py on your computer. This
template describes the worker machines that your cluster requires.

Export the variables that the resource definition uses.

Create a 06_worker.yaml resource definition file:

Optional: If you want to launch additional instances, include additional
resources of type 06_worker.py in your 06_worker.yaml resource definition
file.

Create the deployment by using the gcloud CLI:


To use a GCP Marketplace image, specify the offer to use:
Deployment Manager template for worker machines
You can use the following Deployment Manager template to deploy the worker machines that you need for your Red Hat OpenShift Container Platform cluster:

link:https://raw.githubusercontent.com/openshift/installer/release-4.15/upi/gcp/06_worker.py[role=include]
Installing the OpenShift CLI
You can install the OpenShift CLI (`oc`) to interact with Red Hat OpenShift Container Platform from a command-line interface. You can install oc on Linux, Windows, or macOS.

If you installed an earlier version of oc, you cannot use it to complete all of the commands in Red Hat OpenShift Container Platform 4.16. Download and install the new version of oc.

You can install the OpenShift CLI (oc) binary on Linux by using the following procedure.

Navigate to the Red Hat OpenShift Container Platform downloads page on the Red Hat Customer Portal.

Select the architecture from the Product Variant drop-down list.

Select the appropriate version from the Version drop-down list.

Click Download Now next to the OpenShift v4.16 Linux Client entry and save the file.

Unpack the archive:

Place the oc binary in a directory that is on your PATH.


After you install the OpenShift CLI, it is available using the oc command:



You can install the OpenShift CLI (oc) binary on Windows by using the following procedure.

Navigate to the Red Hat OpenShift Container Platform downloads page on the Red Hat Customer Portal.

Select the appropriate version from the Version drop-down list.

Click Download Now next to the OpenShift v4.16 Windows Client entry and save the file.

Unzip the archive with a ZIP program.

Move the oc binary to a directory that is on your PATH.


After you install the OpenShift CLI, it is available using the oc command:



You can install the OpenShift CLI (oc) binary on macOS by using the following procedure.

Navigate to the Red Hat OpenShift Container Platform downloads page on the Red Hat Customer Portal.

Select the appropriate version from the Version drop-down list.

Click Download Now next to the OpenShift v4.16 macOS Client entry and save the file.

Unpack and unzip the archive.

Move the oc binary to a directory on your PATH.


After you install the OpenShift CLI, it is available using the oc command:
Logging in to the cluster by using the CLI
You can log in to your cluster as a default system user by exporting the cluster kubeconfig file. The kubeconfig file contains information about the cluster that is used by the CLI to connect a client to the correct cluster and API server. The file is specific to a cluster and is created during Red Hat OpenShift Container Platform installation.

You deployed an Red Hat OpenShift Container Platform cluster.

You installed the oc CLI.


Export the kubeadmin credentials:

Verify you can run oc commands successfully using the exported configuration:
Approving the certificate signing requests for your machines
When you add machines to a cluster, two pending certificate signing requests (CSRs) are generated for each machine that you added. You must confirm that these CSRs are approved or, if necessary, approve them yourself. The client requests must be approved first, followed by the server requests.

You added machines to your cluster.


Confirm that the cluster recognizes the machines:

Review the pending CSRs and ensure that you see the client requests with the Pending or Approved status for each machine that you added to the cluster:

If the CSRs were not approved, after all of the pending CSRs for the machines you added are in Pending status, approve the CSRs for your cluster machines:

Now that your client requests are approved, you must review the server requests for each machine that you added to the cluster:

If the remaining CSRs are not approved, and are in the Pending status, approve the CSRs for your cluster machines:

After all client and server CSRs have been approved, the machines have the Ready status. Verify this by running the following command:


For more information on CSRs, see Certificate Signing Requests.
Adding the ingress DNS records
DNS zone configuration is removed when creating Kubernetes manifests and generating Ignition configs. You must manually create DNS records that point at the ingress load balancer. You can create either a wildcard *.apps.{baseDomain}. or specific records. You can use A, CNAME, and other records per your requirements.

Configure a GCP account.

Remove the DNS Zone configuration when creating Kubernetes manifests and
generating Ignition configs.

Create and configure a VPC and associated subnets in GCP.

Create and configure networking and load balancers in GCP.

Create control plane and compute roles.

Create the bootstrap machine.

Create the control plane machines.

Create the worker machines.


Wait for the Ingress router to create a load balancer and populate the EXTERNAL-IP field:

Add the A record to your zones:
Adding ingress firewall rules
The cluster requires several firewall rules. If you do not use a shared VPC, these rules are created by the Ingress Controller via the GCP cloud provider. When you use a shared VPC, you can either create cluster-wide firewall rules for all services now or create each rule based on events, when the cluster requests access. By creating each rule when the cluster requests access, you know exactly which firewall rules are required. By creating cluster-wide firewall rules, you can apply the same rule set across multiple clusters.

If you choose to create each rule based on events, you must create firewall rules after you provision the cluster and during the life of the cluster when the console notifies you that rules are missing. Events that are similar to the following event are displayed, and you must add the firewall rules that are required:

$ oc get events -n openshift-ingress --field-selector="reason=LoadBalancerManualChange"
Firewall change required by security admin: `gcloud compute firewall-rules create k8s-fw-a26e631036a3f46cba28f8df67266d55 --network example-network --description "{\"kubernetes.io/service-name\":\"openshift-ingress/router-default\", \"kubernetes.io/service-ip\":\"35.237.236.234\"}\" --allow tcp:443,tcp:80 --source-ranges 0.0.0.0/0 --target-tags exampl-fqzq7-master,exampl-fqzq7-worker --project example-project`
If you encounter issues when creating these rule-based events, you can configure the cluster-wide firewall rules while your cluster is running.

Creating cluster-wide firewall rules for a shared VPC in GCP
You can create cluster-wide firewall rules to allow the access that the Red Hat OpenShift Container Platform cluster requires.

If you do not choose to create firewall rules based on cluster events, you must create cluster-wide firewall rules.
You exported the variables that the Deployment Manager templates require to deploy your cluster.

You created the networking and load balancing components in GCP that your cluster requires.


Add a single firewall rule to allow the Google Cloud Engine health checks to access all of the services. This rule enables the ingress load balancers to determine the health status of their instances.

Add a single firewall rule to allow access to all cluster services:
Completing a GCP installation on user-provisioned infrastructure
After you start the Red Hat OpenShift Container Platform installation on Google Cloud Platform (GCP) user-provisioned infrastructure, you can monitor the cluster events until the cluster is ready.

Deploy the bootstrap machine for an Red Hat OpenShift Container Platform cluster on user-provisioned GCP infrastructure.

Install the oc CLI and log in.


Complete the cluster installation:

Observe the running state of your cluster.
Telemetry access for Red Hat OpenShift Container Platform
In Red Hat OpenShift Container Platform 4.16, the Telemetry service, which runs by default to provide metrics about cluster health and the success of updates, requires internet access. If your cluster is connected to the internet, Telemetry runs automatically, and your cluster is registered to https://console.redhat.com/openshift [OpenShift Cluster Manager].

After you confirm that your https://console.redhat.com/openshift [OpenShift Cluster Manager] inventory is correct, either maintained automatically by Telemetry or manually by using OpenShift Cluster Manager, use subscription watch to track your Red Hat OpenShift Container Platform subscriptions at the account or multi-cluster level.

See About remote health monitoring for more information about the Telemetry service
Next steps
Customize your cluster.

If necessary, you can
opt out of remote health reporting.