# Configuring Google Cloud Platform features for control plane machines


You can enable or change the configuration of features for your control plane machines by editing values in the control plane machine set specification.
When you save an update to the control plane machine set, the Control Plane Machine Set Operator updates the control plane machines according to your configured update strategy.
For more information, see "Updating the control plane configuration".

# Configuring persistent disk types by using machine sets

You can configure the type of persistent disk that a machine set deploys machines on by editing the machine set YAML file.

For more information about persistent disk types, compatibility, regional availability, and limitations, see the GCP Compute Engine documentation about persistent disks.

1. In a text editor, open the YAML file for an existing machine set or create a new one.
2. Edit the following line under the providerSpec field:

```yaml
apiVersion: machine.openshift.io/v1
kind: ControlPlaneMachineSet
...
spec:
  template:
    spec:
      providerSpec:
        value:
          disks:
            type: pd-ssd 1
```

Control plane nodes must use the pd-ssd disk type.

* Using the Google Cloud Platform console, review the details for a machine deployed by the machine set and verify that the Type field matches the configured disk type.

# Configuring Confidential VM by using machine sets

By editing the machine set YAML file, you can configure the Confidential VM options that a machine set uses for machines that it deploys.

For more information about Confidential VM features, functions, and compatibility, see the GCP Compute Engine documentation about Confidential VM.


[NOTE]
----
Confidential VMs are currently not supported on 64-bit ARM architectures.
If you use Confidential VM, you must ensure that you select a supported region. For details on supported regions and configurations, see the GCP Compute Engine documentation about supported zones.
----

1. In a text editor, open the YAML file for an existing machine set or create a new one.
2. Edit the following section under the providerSpec field:

```yaml
apiVersion: machine.openshift.io/v1
kind: ControlPlaneMachineSet
# ...
    machines_v1beta1_machine_openshift_io:
      spec:
        providerSpec:
          value:
            confidentialCompute: Enabled 1
            onHostMaintenance: Terminate 2
            machineType: n2d-standard-8 3
# ...
```

Specify whether Confidential VM is enabled. The following values are valid:
Enabled:: Enables Confidential VM with a default selection of Confidential VM technology. The default selection is AMD Secure Encrypted Virtualization (AMD SEV).
Disabled:: Disables Confidential VM.
AMDEncryptedVirtualization:: Enables Confidential VM using AMD SEV. AMD SEV supports c2d, n2d, and c3d machines.
AMDEncryptedVirtualizationNestedPaging:: Enables Confidential VM using AMD Secure Encrypted Virtualization Secure Nested Paging (AMD SEV-SNP). AMD SEV-SNP supports n2d machines.
IntelTrustedDomainExtensions:: Enables Confidential VM using Intel Trusted Domain Extensions (Intel TDX). Intel TDX supports n2d machines.
Specify the behavior of the VM during a host maintenance event, such as a hardware or software update. For a machine that uses Confidential VM, this value must be set to Terminate, which stops the VM. Confidential VM does not support live VM migration.
Specify a machine type that supports the Confidential VM option that you specified in the confidentialCompute field.

* On the Google Cloud Platform console, review the details for a machine deployed by the machine set and verify that the Confidential VM options match the values that you configured.

# Configuring Shielded VM options by using machine sets

By editing the machine set YAML file, you can configure the Shielded VM options that a machine set uses for machines that it deploys.

For more information about Shielded VM features and functionality, see the GCP Compute Engine documentation about Shielded VM.

1. In a text editor, open the YAML file for an existing machine set or create a new one.
2. Edit the following section under the providerSpec field:

```yaml
apiVersion: machine.openshift.io/v1
kind: ControlPlaneMachineSet
# ...
spec:
  template:
    spec:
      providerSpec:
        value:
          shieldedInstanceConfig: 1
            integrityMonitoring: Enabled 2
            secureBoot: Disabled 3
            virtualizedTrustedPlatformModule: Enabled 4
# ...
```

In this section, specify any Shielded VM options that you want.
Specify whether integrity monitoring is enabled. Valid values are Disabled or Enabled.

[NOTE]
----
When integrity monitoring is enabled, you must not disable virtual trusted platform module (vTPM).
----
Specify whether UEFI Secure Boot is enabled. Valid values are Disabled or Enabled.
Specify whether vTPM is enabled. Valid values are Disabled or Enabled.

* Using the Google Cloud Platform console, review the details for a machine deployed by the machine set and verify that the Shielded VM options match the values that you configured.

* What is Shielded VM? (GCP documentation)
* Secure Boot (GCP documentation)
* Virtual Trusted Platform Module (vTPM) (GCP documentation)
* Integrity monitoring (GCP documentation)

# Enabling customer-managed encryption keys for a machine set

Google Cloud Platform (GCP) Compute Engine allows users to supply an encryption key to encrypt data on disks at rest. The key is used to encrypt the data encryption key, not to encrypt the customer&#8217;s data. By default, Compute Engine encrypts this data by using Compute Engine keys.

You can enable encryption with a customer-managed key in clusters that use the Machine API. You must first create a KMS key and assign the correct permissions to a service account. The KMS key name, key ring name, and location are required to allow a service account to use your key.


[NOTE]
----
If you do not want to use a dedicated service account for the KMS encryption, the Compute Engine default service account is used instead. You must grant the default service account permission to access the keys if you do not use a dedicated service account. The Compute Engine default service account name follows the service-<project_number>@compute-system.iam.gserviceaccount.com pattern.
----

1. To allow a specific service account to use your KMS key and to grant the service account the correct IAM role, run the following command with your KMS key name, key ring name, and location:

```terminal
$ gcloud kms keys add-iam-policy-binding <key_name> \
  --keyring <key_ring_name> \
  --location <key_ring_location> \
  --member "serviceAccount:service-<project_number>@compute-system.iam.gserviceaccount.com‚Äù \
  --role roles/cloudkms.cryptoKeyEncrypterDecrypter
```

2. Configure the encryption key under the providerSpec field in your machine set YAML file. For example:

```yaml
apiVersion: machine.openshift.io/v1
kind: ControlPlaneMachineSet
...
spec:
  template:
    spec:
      providerSpec:
        value:
          disks:
          - type:
            encryptionKey:
              kmsKey:
                name: machine-encryption-key 1
                keyRing: openshift-encrpytion-ring 2
                location: global 3
                projectID: openshift-gcp-project 4
              kmsKeyServiceAccount: openshift-service-account@openshift-gcp-project.iam.gserviceaccount.com 5
```

The name of the customer-managed encryption key that is used for the disk encryption.
The name of the KMS key ring that the KMS key belongs to.
The GCP location in which the KMS key ring exists.
Optional: The ID of the project in which the KMS key ring exists. If a project ID is not set, the machine set projectID in which the machine set was created is used.
Optional: The service account that is used for the encryption request for the given KMS key. If a service account is not set, the Compute Engine default service account is used.

When a new machine is created by using the updated providerSpec object configuration, the disk encryption key is encrypted with the KMS key.

# Additional resources

* Updating the control plane configuration
* Changing control plane configuration options for Google Cloud Platform